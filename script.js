// Â§öË™ûË®ÄÈÖçÁΩÆ
const translations = {
    'en': {
        // Hero
        heroTitle: 'Start Page',
        heroSubtitle: 'Quick search and manage your bookmarks, all starts here.',
        // Search
        searchPlaceholder: 'Search anything...',
        searchButton: 'Search',
        // Toolbar
        addBookmark: 'Add Bookmark',
        manageCategories: 'Manage Categories',
        settings: 'Settings',
        // Bookmarks
        myBookmarks: 'My Bookmarks',
        bookmarksDesc: 'Your frequently visited sites, click to open.',
        noBookmarks: 'No bookmarks yet, click the button above to add!',
        // Modals
        addBookmarkTitle: 'Add Bookmark',
        editBookmarkTitle: 'Edit Bookmark',
        categoryLabel: 'Category',
        nameLabel: 'Name',
        urlLabel: 'URL',
        iconLabel: 'Icon',
        autoFetch: 'Auto Fetch',
        save: 'Save',
        cancel: 'Cancel',
        done: 'Done',
        mainList: 'Main List (No Category)',
        newCategory: '+ Create New Category',
        enterNewCategory: 'Enter new category',
        enterCategoryName: 'Enter new category name',
        namePlaceholder: 'Website name',
        urlPlaceholder: 'https://example.com',
        iconPlaceholder: 'üåê Emoji or image URL',
        iconHint: 'Enter emoji, image URL, or use auto fetch',
        iconSearch: 'Search Icon',
        manageCategoriesTitle: 'Manage Categories',
        categoriesDesc: 'Create categories to organize bookmarks. When a category is deleted, bookmarks return to main list.',
        noCategories: 'No categories yet',
        addCategoryBtn: '+ Add',
        deleteCategory: 'Delete',
        // Settings
        settingsTitle: 'Settings',
        searchEngineSection: 'Search Engine',
        customSearchUrl: 'Custom Search Engine URL',
        customSearchHint: 'Use {query} as the search keyword placeholder',
        backgroundSection: 'Background Settings',
        backgroundType: 'Background Type',
        gradient: 'Gradient',
        image: 'Image',
        solidColor: 'Solid Color',
        selectGradient: 'Select Gradient',
        imageUrl: 'Image URL',
        imageHint: 'Tip: Use Unsplash, e.g. https://source.unsplash.com/1920x1080/?nature',
        selectColor: 'Select Color',
        appearanceSection: 'Display Effects (Appearance)',
        backgroundBlur: 'Background Blur',
        enableBlur: 'Enable Background Blur',
        blurDepth: 'Blur Depth',
        backgroundFilter: 'Background Filter',
        filterNone: 'None',
        filterWhite: 'White Filter',
        filterBlack: 'Black Filter',
        filterOpacity: 'Filter Opacity',
        languageSection: 'Language',
        selectLanguage: 'Select Language',
        darkModeSection: 'Dark Mode',
        enableDarkMode: 'Enable Dark Mode',
        darkModeDepth: 'Dark Mode Depth',
        // Gradient presets
        gradientDefault: 'Sky Blue',
        gradientSunset: 'Sunset Orange',
        gradientOcean: 'Ocean Blue',
        gradientPurple: 'Dreamy Purple',
        gradientGreen: 'Forest Green',
        gradientDark: 'Starry Night',
        // Alerts
        alertFillRequired: 'Please fill in name and URL',
        alertEnterCategory: 'Please enter new category name',
        alertCategoryExists: 'This category already exists',
        alertDeleteBookmark: 'Are you sure you want to delete this bookmark?',
        alertDeleteCategory: 'Are you sure you want to delete "{category}" category?\nBookmarks in this category will be moved to main list.',
        alertSetCustomUrl: 'Please set custom search engine URL first',
        alertIconFetched: 'Icon automatically filled!',
        alertInvalidUrl: 'Please confirm URL format is correct'
    },
    'zh-CN': {
        // Hero
        heroTitle: 'Start Page',
        heroSubtitle: 'Âø´ÈÄüÊêúÁ¥¢„ÄÅÁÆ°ÁêÜÊî∂ËóèÔºå‰∏ÄÂàá‰ªéËøôÈáåÂºÄÂßã„ÄÇ',
        // Search
        searchPlaceholder: 'ÊêúÁ¥¢‰ªª‰ΩïÂÜÖÂÆπ...',
        searchButton: 'ÊêúÁ¥¢',
        // Toolbar
        addBookmark: 'Êñ∞Â¢û‰π¶Á≠æ',
        manageCategories: 'ÁÆ°ÁêÜÂàÜÁ±ª',
        settings: 'ËÆæÁΩÆ',
        // Bookmarks
        myBookmarks: 'ÊàëÁöÑ‰π¶Á≠æ',
        bookmarksDesc: 'Â∏∏Áî®ÁΩëÁ´ôÈÉΩÂú®ËøôÈáåÔºåÁÇπÂáªÂç≥ÂèØÊâìÂºÄ„ÄÇ',
        noBookmarks: 'ËøòÊ≤°Êúâ‰π¶Á≠æÔºåÁÇπÂáª‰∏äÊñπÊåâÈíÆÊñ∞Â¢ûÔºÅ',
        // Modals
        addBookmarkTitle: 'Êñ∞Â¢û‰π¶Á≠æ',
        editBookmarkTitle: 'ÁºñËæë‰π¶Á≠æ',
        categoryLabel: 'ÂàÜÁ±ª',
        nameLabel: 'ÂêçÁß∞',
        urlLabel: 'ÁΩëÂùÄ',
        iconLabel: 'ÂõæÊ†á',
        autoFetch: 'Ëá™Âä®ÊäìÂèñ',
        save: '‰øùÂ≠ò',
        cancel: 'ÂèñÊ∂à',
        done: 'ÂÆåÊàê',
        mainList: '‰∏ªÂàóË°®Ôºà‰∏çÂàÜÁ±ªÔºâ',
        newCategory: '+ Âª∫Á´ãÊñ∞ÂàÜÁ±ª',
        enterNewCategory: 'ËæìÂÖ•Êñ∞ÂàÜÁ±ª',
        enterCategoryName: 'ËæìÂÖ•Êñ∞ÂàÜÁ±ªÂêçÁß∞',
        namePlaceholder: 'ÁΩëÁ´ôÂêçÁß∞',
        urlPlaceholder: 'https://example.com',
        iconPlaceholder: 'üåê Emoji ÊàñÂõæÁâáÁΩëÂùÄ',
        iconHint: 'ÂèØËæìÂÖ• Emoji„ÄÅÂõæÁâáÁΩëÂùÄÔºåÊàñ‰ΩøÁî®Ëá™Âä®ÊäìÂèñ',
        iconSearch: 'ÊêúÁ¥¢ÂõæÊ†á',
        manageCategoriesTitle: 'ÁÆ°ÁêÜÂàÜÁ±ª',
        categoriesDesc: 'Âª∫Á´ãÂàÜÁ±ªÊù•Êï¥ÁêÜ‰π¶Á≠æ„ÄÇÂà†Èô§ÂàÜÁ±ªÊó∂Ôºå‰π¶Á≠æ‰ºöÂõûÂà∞‰∏ªÂàóË°®„ÄÇ',
        noCategories: 'ËøòÊ≤°ÊúâÂàÜÁ±ª',
        addCategoryBtn: '+ Êñ∞Â¢û',
        deleteCategory: 'Âà†Èô§',
        // Settings
        settingsTitle: 'ËÆæÁΩÆ',
        searchEngineSection: 'ÊêúÁ¥¢ÂºïÊìé',
        customSearchUrl: 'Ëá™ÂÆö‰πâÊêúÁ¥¢ÂºïÊìé URL',
        customSearchHint: '‰ΩøÁî® {query} ‰Ωú‰∏∫ÊêúÁ¥¢ÂÖ≥ÈîÆÂ≠óÁöÑÂç†‰ΩçÁ¨¶',
        backgroundSection: 'ËÉåÊôØËÆæÁΩÆ',
        backgroundType: 'ËÉåÊôØÁ±ªÂûã',
        gradient: 'Ê∏êÂ±Ç',
        image: 'ÂõæÁâá',
        solidColor: 'Á∫ØËâ≤',
        selectGradient: 'ÈÄâÊã©Ê∏êÂ±Ç',
        imageUrl: 'ÂõæÁâáÁΩëÂùÄ',
        imageHint: 'ÊèêÁ§∫ÔºöÂèØ‰ΩøÁî® UnsplashÔºåÂ¶Ç https://source.unsplash.com/1920x1080/?nature',
        selectColor: 'ÈÄâÊã©È¢úËâ≤',
        appearanceSection: 'ÊòæÁ§∫ÊïàÊûúÔºàÂ§ñËßÇÔºâ',
        backgroundBlur: 'ËÉåÊôØÊ®°Á≥ä',
        enableBlur: 'ÂêØÁî®ËÉåÊôØÊ®°Á≥ä',
        blurDepth: 'Ê®°Á≥äÊ∑±Â∫¶',
        backgroundFilter: 'ËÉåÊôØÊª§Èïú',
        filterNone: 'Êó†',
        filterWhite: 'ÁôΩËâ≤Êª§Èïú',
        filterBlack: 'ÈªëËâ≤Êª§Èïú',
        filterOpacity: 'Êª§ÈïúÈÄèÊòéÂ∫¶',
        languageSection: 'ËØ≠Ë®Ä',
        selectLanguage: 'ÈÄâÊã©ËØ≠Ë®Ä',
        darkModeSection: 'Â§úÈó¥Ê®°Âºè',
        enableDarkMode: 'ÂêØÁî®Â§úÈó¥Ê®°Âºè',
        darkModeDepth: 'Ê∑±Ëâ≤Âº∫Â∫¶',
        // Gradient presets
        gradientDefault: 'Â§©Á©∫Ëìù',
        gradientSunset: 'Êó•ËêΩÊ©òÁ∫¢',
        gradientOcean: 'Êµ∑Ê¥ãËìùÁªø',
        gradientPurple: 'Ê¢¶ÂπªÁ¥´',
        gradientGreen: 'Ê£ÆÊûóÁªø',
        gradientDark: 'ÊòüÂ§úÈªë',
        // Alerts
        alertFillRequired: 'ËØ∑Â°´ÂÜôÂêçÁß∞ÂíåÁΩëÂùÄ',
        alertEnterCategory: 'ËØ∑ËæìÂÖ•Êñ∞ÂàÜÁ±ªÂêçÁß∞',
        alertCategoryExists: 'Ê≠§ÂàÜÁ±ªÂ∑≤Â≠òÂú®',
        alertDeleteBookmark: 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰π¶Á≠æÂêóÔºü',
        alertDeleteCategory: 'Á°ÆÂÆöË¶ÅÂà†Èô§„Äå{category}„ÄçÂàÜÁ±ªÂêóÔºü\nÊ≠§ÂàÜÁ±ª‰∏ãÁöÑ‰π¶Á≠æÂ∞ÜÁßªËá≥‰∏ªÂàóË°®„ÄÇ',
        alertSetCustomUrl: 'ËØ∑ÂÖàËÆæÁΩÆËá™ÂÆö‰πâÊêúÁ¥¢ÂºïÊìé URL',
        alertIconFetched: 'Â∑≤Ëá™Âä®Â°´ÂÖ•ÁΩëÁ´ôÂõæÊ†áÔºÅ',
        alertInvalidUrl: 'Êó†Ê≥ïËé∑ÂèñÂõæÊ†áÔºåËØ∑Á°ÆËÆ§ÁΩëÂùÄÊ†ºÂºèÊ≠£Á°Æ'
    },
    'zh-TW': {
        // Hero
        heroTitle: 'Start Page',
        heroSubtitle: 'Âø´ÈÄüÊêúÂ∞ã„ÄÅÁÆ°ÁêÜÊî∂ËóèÔºå‰∏ÄÂàáÂæûÈÄôË£°ÈñãÂßã„ÄÇ',
        // Search
        searchPlaceholder: 'ÊêúÂ∞ã‰ªª‰ΩïÂÖßÂÆπ...',
        searchButton: 'ÊêúÂ∞ã',
        // Toolbar
        addBookmark: 'Êñ∞Â¢ûÊõ∏Á±§',
        manageCategories: 'ÁÆ°ÁêÜÂàÜÈ°û',
        settings: 'Ë®≠ÂÆö',
        // Bookmarks
        myBookmarks: 'ÊàëÁöÑÊõ∏Á±§',
        bookmarksDesc: 'Â∏∏Áî®Á∂≤Á´ôÈÉΩÂú®ÈÄôË£°ÔºåÈªûÊìäÂç≥ÂèØÈñãÂïü„ÄÇ',
        noBookmarks: 'ÈÇÑÊ≤íÊúâÊõ∏Á±§ÔºåÈªûÊìä‰∏äÊñπÊåâÈàïÊñ∞Â¢ûÔºÅ',
        // Modals
        addBookmarkTitle: 'Êñ∞Â¢ûÊõ∏Á±§',
        editBookmarkTitle: 'Á∑®ËºØÊõ∏Á±§',
        categoryLabel: 'ÂàÜÈ°û',
        nameLabel: 'ÂêçÁ®±',
        urlLabel: 'Á∂≤ÂùÄ',
        iconLabel: 'ÂúñÁ§∫',
        autoFetch: 'Ëá™ÂãïÊäìÂèñ',
        save: 'ÂÑ≤Â≠ò',
        cancel: 'ÂèñÊ∂à',
        done: 'ÂÆåÊàê',
        mainList: '‰∏ªÂàóË°®Ôºà‰∏çÂàÜÈ°ûÔºâ',
        newCategory: '+ Âª∫Á´ãÊñ∞ÂàÜÈ°û',
        enterNewCategory: 'Ëº∏ÂÖ•Êñ∞ÂàÜÈ°û',
        enterCategoryName: 'Ëº∏ÂÖ•Êñ∞ÂàÜÈ°ûÂêçÁ®±',
        namePlaceholder: 'Á∂≤Á´ôÂêçÁ®±',
        urlPlaceholder: 'https://example.com',
        iconPlaceholder: 'üåê Emoji ÊàñÂúñÁâáÁ∂≤ÂùÄ',
        iconHint: 'ÂèØËº∏ÂÖ• Emoji„ÄÅÂúñÁâáÁ∂≤ÂùÄÔºåÊàñ‰ΩøÁî®Ëá™ÂãïÊäìÂèñ',
        iconSearch: 'ÊêúÂ∞ãÂúñÊ®ô',
        manageCategoriesTitle: 'ÁÆ°ÁêÜÂàÜÈ°û',
        categoriesDesc: 'Âª∫Á´ãÂàÜÈ°û‰æÜÊï¥ÁêÜÊõ∏Á±§„ÄÇÂà™Èô§ÂàÜÈ°ûÊôÇÔºåÊõ∏Á±§ÊúÉÂõûÂà∞‰∏ªÂàóË°®„ÄÇ',
        noCategories: 'ÈÇÑÊ≤íÊúâÂàÜÈ°û',
        addCategoryBtn: '+ Êñ∞Â¢û',
        deleteCategory: 'Âà™Èô§',
        // Settings
        settingsTitle: 'Ë®≠ÂÆö',
        searchEngineSection: 'ÊêúÂ∞ãÂºïÊìé',
        customSearchUrl: 'Ëá™Ë®ÇÊêúÂ∞ãÂºïÊìé URL',
        customSearchHint: '‰ΩøÁî® {query} ‰ΩúÁÇ∫ÊêúÂ∞ãÈóúÈçµÂ≠óÁöÑ‰Ωî‰ΩçÁ¨¶',
        backgroundSection: 'ËÉåÊôØË®≠ÂÆö',
        backgroundType: 'ËÉåÊôØÈ°ûÂûã',
        gradient: 'Êº∏Â±§',
        image: 'ÂúñÁâá',
        solidColor: 'Á¥îËâ≤',
        selectGradient: 'ÈÅ∏ÊìáÊº∏Â±§',
        imageUrl: 'ÂúñÁâáÁ∂≤ÂùÄ',
        imageHint: 'ÊèêÁ§∫ÔºöÂèØ‰ΩøÁî® UnsplashÔºåÂ¶Ç https://source.unsplash.com/1920x1080/?nature',
        selectColor: 'ÈÅ∏ÊìáÈ°èËâ≤',
        appearanceSection: 'È°ØÁ§∫ÊïàÊûúÔºàÂ§ñËßÄÔºâ',
        backgroundBlur: 'ËÉåÊôØÊ®°Á≥ä',
        enableBlur: 'ÂïüÁî®ËÉåÊôØÊ®°Á≥ä',
        blurDepth: 'Ê®°Á≥äÊ∑±Â∫¶',
        backgroundFilter: 'ËÉåÊôØÊøæÈè°',
        filterNone: 'ÁÑ°',
        filterWhite: 'ÁôΩËâ≤ÊøæÈè°',
        filterBlack: 'ÈªëËâ≤ÊøæÈè°',
        filterOpacity: 'ÊøæÈè°ÈÄèÊòéÂ∫¶',
        languageSection: 'Ë™ûË®Ä',
        selectLanguage: 'ÈÅ∏ÊìáË™ûË®Ä',
        darkModeSection: 'Â§úÈñìÊ®°Âºè',
        enableDarkMode: 'ÂïüÁî®Â§úÈñìÊ®°Âºè',
        darkModeDepth: 'Ê∑±Ëâ≤Âº∑Â∫¶',
        // Gradient presets
        gradientDefault: 'Â§©Á©∫Ëóç',
        gradientSunset: 'Êó•ËêΩÊ©òÁ¥Ö',
        gradientOcean: 'Êµ∑Ê¥ãËóçÁ∂†',
        gradientPurple: 'Â§¢ÂπªÁ¥´',
        gradientGreen: 'Ê£ÆÊûóÁ∂†',
        gradientDark: 'ÊòüÂ§úÈªë',
        // Alerts
        alertFillRequired: 'Ë´ãÂ°´ÂØ´ÂêçÁ®±ÂíåÁ∂≤ÂùÄ',
        alertEnterCategory: 'Ë´ãËº∏ÂÖ•Êñ∞ÂàÜÈ°ûÂêçÁ®±',
        alertCategoryExists: 'Ê≠§ÂàÜÈ°ûÂ∑≤Â≠òÂú®',
        alertDeleteBookmark: 'Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÊõ∏Á±§ÂóéÔºü',
        alertDeleteCategory: 'Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå{category}„ÄçÂàÜÈ°ûÂóéÔºü\nÊ≠§ÂàÜÈ°û‰∏ãÁöÑÊõ∏Á±§Â∞áÁßªËá≥‰∏ªÂàóË°®„ÄÇ',
        alertSetCustomUrl: 'Ë´ãÂÖàË®≠ÂÆöËá™Ë®ÇÊêúÂ∞ãÂºïÊìé URL',
        alertIconFetched: 'Â∑≤Ëá™ÂãïÂ°´ÂÖ•Á∂≤Á´ôÂúñÁ§∫ÔºÅ',
        alertInvalidUrl: 'ÁÑ°Ê≥ïÁç≤ÂèñÂúñÁ§∫ÔºåË´ãÁ¢∫Ë™çÁ∂≤ÂùÄÊ†ºÂºèÊ≠£Á¢∫'
    }
};

// Áï∂ÂâçË™ûË®Ä
let currentLanguage = 'zh-TW';

// Áç≤ÂèñÁøªË≠ØÊñáÂ≠ó
function t(key) {
    return translations[currentLanguage]?.[key] || translations['zh-TW'][key] || key;
}

// ÊêúÂ∞ãÂºïÊìéÈÖçÁΩÆÔºà‰ΩøÁî®ÁúüÂØ¶ÂìÅÁâåÂúñÊ®ôÔºâ
const searchEngines = {
    google: { 
        url: 'https://www.google.com/search?q={query}', 
        icon: 'https://cdn.simpleicons.org/google'
    },
    bing: { 
        url: 'https://www.bing.com/search?q={query}', 
        icon: 'https://cdn.simpleicons.org/bing/008373'
    },
    duckduckgo: { 
        url: 'https://duckduckgo.com/?q={query}', 
        icon: 'https://cdn.simpleicons.org/duckduckgo/DE5833'
    },
    baidu: { 
        url: 'https://www.baidu.com/s?wd={query}', 
        icon: 'https://cdn.simpleicons.org/baidu/2319DC'
    },
    custom: { 
        url: '', 
        icon: 'lucide:settings' // ‰øùÁïô Lucide ÂúñÊ®ô
    }
};

// ËÉåÊôØÊº∏Â±§È†êË®≠
const gradientPresets = {
    default: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    sunset: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
    ocean: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
    purple: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
    green: 'linear-gradient(135deg, #81FBB8 0%, #28C76F 100%)',
    dark: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)'
};

// ÂÖ®Â±ÄËÆäÊï∏
let bookmarks = [];
let categories = [];
let editingBookmarkId = null;
let currentSearchEngine = 'google';

// ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    loadLanguage();
    loadSettings();
    loadCategories();
    loadBookmarks();
    loadDarkMode();
    initEventListeners();
    updateSearchIcon();
    updateUILanguage();
    // initialize lucide icons
    if (window.lucide) window.lucide.createIcons();
});

// ËºâÂÖ•Ë™ûË®ÄË®≠ÂÆö
function loadLanguage() {
    const saved = localStorage.getItem('language');
    if (saved && translations[saved]) {
        currentLanguage = saved;
    } else {
        // Ëá™ÂãïÊ™¢Ê∏¨ÁÄèË¶ΩÂô®Ë™ûË®Ä
        const browserLang = navigator.language || navigator.userLanguage;
        if (browserLang.startsWith('zh')) {
            currentLanguage = browserLang.includes('CN') ? 'zh-CN' : 'zh-TW';
        } else {
            currentLanguage = 'en';
        }
    }
}

// ÂàáÊèõË™ûË®Ä
function changeLanguage(lang) {
    if (!translations[lang]) return;
    currentLanguage = lang;
    localStorage.setItem('language', lang);
    updateUILanguage();
    renderBookmarks();
    updateCategorySelect();
}

// Êõ¥Êñ∞ UI Ë™ûË®Ä
function updateUILanguage() {
    // Update all elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (key) {
            el.textContent = t(key);
        }
    });
    
    // Update placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (key) {
            el.placeholder = t(key);
        }
    });
    
    // Hero
    const heroTitle = document.querySelector('.hero-title');
    const heroSubtitle = document.querySelector('.hero-subtitle');
    if (heroTitle) heroTitle.textContent = t('heroTitle');
    if (heroSubtitle) heroSubtitle.textContent = t('heroSubtitle');
    
    // Search
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    if (searchInput) searchInput.placeholder = t('searchPlaceholder');
    if (searchBtn) searchBtn.textContent = t('searchButton');
    
    // Toolbar buttons with icons
    const addBtn = document.getElementById('addBookmarkBtn');
    if (addBtn) {
        const icon = addBtn.querySelector('i');
        addBtn.innerHTML = '';
        if (icon) addBtn.appendChild(icon.cloneNode(true));
        addBtn.appendChild(document.createTextNode(' ' + t('addBookmark')));
    }
    
    const manageCatBtn = document.getElementById('manageCategoriesBtn');
    if (manageCatBtn) {
        const icon = manageCatBtn.querySelector('i');
        manageCatBtn.innerHTML = '';
        if (icon) manageCatBtn.appendChild(icon.cloneNode(true));
        manageCatBtn.appendChild(document.createTextNode(' ' + t('manageCategories')));
    }
    
    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn) {
        const icon = settingsBtn.querySelector('i');
        settingsBtn.innerHTML = '';
        if (icon) settingsBtn.appendChild(icon.cloneNode(true));
        settingsBtn.appendChild(document.createTextNode(' ' + t('settings')));
    }
    
    // Bookmarks header
    const bookmarkHeader = document.querySelector('.bookmark-card__header h2');
    const bookmarkDesc = document.querySelector('.bookmark-card__header p');
    if (bookmarkHeader) bookmarkHeader.textContent = t('myBookmarks');
    if (bookmarkDesc) bookmarkDesc.textContent = t('bookmarksDesc');
    
    // Update gradient select options
    const gradientSelect = document.getElementById('gradientPreset');
    if (gradientSelect) {
        const currentValue = gradientSelect.value;
        gradientSelect.innerHTML = `
            <option value="default">${t('gradientDefault')}</option>
            <option value="sunset">${t('gradientSunset')}</option>
            <option value="ocean">${t('gradientOcean')}</option>
            <option value="purple">${t('gradientPurple')}</option>
            <option value="green">${t('gradientGreen')}</option>
            <option value="dark">${t('gradientDark')}</option>
        `;
        gradientSelect.value = currentValue || 'default';
    }
    
    // Update overlay select options
    const overlaySelect = document.getElementById('overlaySelect');
    if (overlaySelect) {
        const currentValue = overlaySelect.value;
        overlaySelect.innerHTML = `
            <option value="none">${t('filterNone')}</option>
            <option value="white">${t('filterWhite')}</option>
            <option value="black">${t('filterBlack')}</option>
        `;
        overlaySelect.value = currentValue || 'none';
    }
    
    // Update language select
    const langSelect = document.getElementById('languageSelect');
    if (langSelect) langSelect.value = currentLanguage;
    
    // Update quick language dropdown
    document.querySelectorAll('.lang-option').forEach(option => {
        const isActive = option.getAttribute('data-lang') === currentLanguage;
        option.classList.toggle('active', isActive);
    });
    
    // Reinitialize lucide icons
    if (window.lucide) window.lucide.createIcons();
}

// ËºâÂÖ•Ë®≠ÂÆö
function loadSettings() {
    const savedEngine = localStorage.getItem('searchEngine') || 'google';
    const customUrl = localStorage.getItem('customSearchUrl') || '';
    
    currentSearchEngine = savedEngine;
    const customUrlInput = document.getElementById('customSearchUrl');
    if (customUrlInput) customUrlInput.value = customUrl;
    
    if (savedEngine === 'custom') {
        searchEngines.custom.url = customUrl;
    }
    
    // Ë®≠ÁΩÆÊ¥ªÂãïÊ®ôÁ±§
    setActiveEngineTab(savedEngine);
    
    // ËºâÂÖ•ËÉåÊôØË®≠ÂÆö
    loadBackgroundSettings();
    // ËºâÂÖ•Â§ñËßÄË®≠ÂÆöÔºàÊ®°Á≥ä/ÊøæÈè°Ôºâ
    loadAppearanceSettings();
}

// ËºâÂÖ•ËÉåÊôØË®≠ÂÆö
function loadBackgroundSettings() {
    const bgType = localStorage.getItem('bgType') || 'image';
    const bgValue = localStorage.getItem('bgValue') || 'https://img.zakk.au/file/1758520685708_71119.jpg';

    const radio = document.querySelector(`input[name="bgType"][value="${bgType}"]`);
    if (radio) radio.checked = true;
    showBgOptions(bgType);

    if (bgType === 'gradient') {
        const sel = document.getElementById('gradientPreset');
        if (sel) sel.value = bgValue;
        applyBackground('gradient', bgValue);
    } else if (bgType === 'image') {
        const inp = document.getElementById('bgImageUrl');
        if (inp) inp.value = bgValue;
        applyBackground('image', bgValue);
    } else if (bgType === 'color') {
        const color = document.getElementById('bgColor');
        if (color) color.value = bgValue;
        applyBackground('color', bgValue);
    }
}

// ÊáâÁî®ËÉåÊôØ
function applyBackground(type, value) {
    const body = document.body;
    
    if (type === 'gradient') {
        body.style.background = gradientPresets[value] || gradientPresets.default;
        body.style.backgroundSize = 'cover';
        body.style.backgroundAttachment = 'fixed';
    } else if (type === 'image') {
        body.style.background = `url(${value})`;
        body.style.backgroundSize = 'cover';
        body.style.backgroundPosition = 'center';
        body.style.backgroundAttachment = 'fixed';
    } else if (type === 'color') {
        body.style.background = value;
    }
}

// È°ØÁ§∫ËÉåÊôØÈÅ∏È†Ö
function showBgOptions(type) {
    const grad = document.getElementById('gradientSettings');
    const img = document.getElementById('imageSettings');
    const col = document.getElementById('colorSettings');
    if (grad) grad.classList.toggle('hidden', type !== 'gradient');
    if (img) img.classList.toggle('hidden', type !== 'image');
    if (col) col.classList.toggle('hidden', type !== 'color');
}

// ÂÑ≤Â≠òË®≠ÂÆö
function saveSettings() {
    const customUrl = document.getElementById('customSearchUrl').value;
    localStorage.setItem('customSearchUrl', customUrl);
    searchEngines.custom.url = customUrl;
    
    // ÂÑ≤Â≠òËÉåÊôØË®≠ÂÆö
    const bgType = document.querySelector('input[name="bgType"]:checked').value;
    let bgValue = '';
    
    if (bgType === 'gradient') {
        bgValue = document.getElementById('gradientPreset').value;
    } else if (bgType === 'image') {
        bgValue = document.getElementById('bgImageUrl').value;
    } else if (bgType === 'color') {
        bgValue = document.getElementById('bgColor').value;
    }
    
    localStorage.setItem('bgType', bgType);
    localStorage.setItem('bgValue', bgValue);
    applyBackground(bgType, bgValue);
    
    // ‰πüÂÑ≤Â≠òÂ§ñËßÄË®≠ÂÆö
    saveAppearanceSettings();
    
    // ÂÑ≤Â≠òË™ûË®ÄË®≠ÂÆö
    const langSelect = document.getElementById('languageSelect');
    if (langSelect && langSelect.value !== currentLanguage) {
        changeLanguage(langSelect.value);
    }

    closeModal('settingsModal');
}

// Appearance: blur + overlay
function loadAppearanceSettings() {
    const blurEnabled = localStorage.getItem('blurEnabled');
    const blurAmount = localStorage.getItem('blurAmount');
    const overlayType = localStorage.getItem('overlayType') || 'none';
    const overlayOpacity = localStorage.getItem('overlayOpacity');

    const blurToggle = document.getElementById('blurToggle');
    const blurRange = document.getElementById('blurRange');
    const blurValue = document.getElementById('blurValue');
    const overlaySelect = document.getElementById('overlaySelect');
    const overlayRange = document.getElementById('overlayOpacity');
    const overlayValue = document.getElementById('overlayValue');

    if (blurToggle) blurToggle.checked = blurEnabled === 'true' || blurEnabled === null;
    if (blurRange) blurRange.value = blurAmount || 16;
    if (blurValue) blurValue.textContent = blurRange ? blurRange.value : (blurAmount || 16);
    if (overlaySelect) overlaySelect.value = overlayType;
    if (overlayRange) overlayRange.value = overlayOpacity !== null ? overlayOpacity : 0.4;
    if (overlayValue) overlayValue.textContent = Number(overlayRange ? overlayRange.value : (overlayOpacity !== null ? overlayOpacity : 0.4)).toFixed(2);

    applyAppearanceSettings();
}

function saveAppearanceSettings() {
    const blurToggle = document.getElementById('blurToggle');
    const blurRange = document.getElementById('blurRange');
    const overlaySelect = document.getElementById('overlaySelect');
    const overlayRange = document.getElementById('overlayOpacity');

    if (blurToggle) localStorage.setItem('blurEnabled', blurToggle.checked);
    if (blurRange) localStorage.setItem('blurAmount', blurRange.value);
    if (overlaySelect) localStorage.setItem('overlayType', overlaySelect.value);
    if (overlayRange) localStorage.setItem('overlayOpacity', overlayRange.value);

    applyAppearanceSettings();
}

function applyAppearanceSettings() {
    const blurEnabled = localStorage.getItem('blurEnabled') === 'true' || localStorage.getItem('blurEnabled') === null;
    const blurAmount = localStorage.getItem('blurAmount') || 16;
    const overlayType = localStorage.getItem('overlayType') || 'none';
    const overlayOpacity = localStorage.getItem('overlayOpacity') !== null ? Number(localStorage.getItem('overlayOpacity')) : 0.4;

    // apply blur via CSS variable
    document.documentElement.style.setProperty('--backdrop-blur', blurEnabled ? `${blurAmount}px` : '0px');

    // overlay
    const overlayEl = document.getElementById('backgroundOverlay');
    if (overlayEl) {
        if (overlayType === 'none') {
            overlayEl.style.background = 'transparent';
        } else if (overlayType === 'white') {
            overlayEl.style.background = `rgba(255,255,255,${overlayOpacity})`;
        } else {
            overlayEl.style.background = `rgba(0,0,0,${overlayOpacity})`;
        }
    }
}

// ÂàùÂßãÂåñ‰∫ã‰ª∂Áõ£ËÅΩ
function initEventListeners() {
    // ÊêúÂ∞ãÂäüËÉΩ
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    const searchBtn = document.getElementById('searchBtn');
    if (searchBtn) searchBtn.addEventListener('click', performSearch);
    
    // ÊêúÂ∞ãÂºïÊìéÊ®ôÁ±§ÂàáÊèõ
    document.querySelectorAll('#engineTabs .engine-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            const engine = this.dataset.engine;
            currentSearchEngine = engine;
            localStorage.setItem('searchEngine', engine);
            setActiveEngineTab(engine);
            updateSearchIcon();
            if (engine === 'custom' && !searchEngines.custom.url) {
                openModal('settingsModal');
            }
        });
    });
    
    // Ë®≠ÂÆöÊåâÈàï
    document.getElementById('settingsBtn').addEventListener('click', function() {
        openModal('settingsModal');
    });
    
    document.getElementById('saveSettings').addEventListener('click', saveSettings);
    
    // ËÉåÊôØÈ°ûÂûãÈÅ∏Êìá
    document.querySelectorAll('input[name="bgType"]').forEach(radio => {
        radio.addEventListener('change', function(e) {
            showBgOptions(e.target.value);
        });
    });
    
    // Êõ∏Á±§ÊåâÈàï
    const addBtn = document.getElementById('addBookmarkBtn');
    if (addBtn) addBtn.addEventListener('click', function() { openBookmarkModal(null, ''); });
    
    document.getElementById('saveBookmark').addEventListener('click', saveBookmark);
    // ÈóúÈñâÁî± data-close ÊéßÂà∂
    document.querySelectorAll('[data-close]').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-close');
            if (id) closeModal(id);
        });
    });
    
    // ÊäìÂèñÂúñÁ§∫ÊåâÈàï
    const autoIconBtn = document.getElementById('autoIconBtn');
    if (autoIconBtn) autoIconBtn.addEventListener('click', fetchFavicon);
    
    // ÂúñÊ®ôÊêúÁ¥¢ÊåâÈàï
    const iconSearchBtn = document.getElementById('iconSearchBtn');
    if (iconSearchBtn) iconSearchBtn.addEventListener('click', openIconSearch);
    
    // Âø´ÈÄüË®≠ÁΩÆÊåâÈàï - Ë™ûË®Ä‰∏ãÊãâÈÅ∏ÂñÆ
    const quickLangBtn = document.getElementById('quickLangBtn');
    const langMenu = document.getElementById('langMenu');
    
    if (quickLangBtn && langMenu) {
        quickLangBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            langMenu.classList.toggle('show');
        });
        
        // Ë™ûË®ÄÈÅ∏È†ÖÈªûÊìä
        document.querySelectorAll('.lang-option').forEach(option => {
            option.addEventListener('click', function() {
                const lang = this.getAttribute('data-lang');
                changeLanguage(lang);
                langMenu.classList.remove('show');
            });
        });
        
        // ÈªûÊìäÂ§ñÈÉ®ÈóúÈñâ‰∏ãÊãâÈÅ∏ÂñÆ
        document.addEventListener('click', function(e) {
            if (!quickLangBtn.contains(e.target) && !langMenu.contains(e.target)) {
                langMenu.classList.remove('show');
            }
        });
    }
    
    const quickDarkModeBtn = document.getElementById('quickDarkModeBtn');
    if (quickDarkModeBtn) {
        quickDarkModeBtn.addEventListener('click', toggleDarkMode);
    }
    
    // Â§úÈñìÊ®°ÂºèÂàáÊèõ
    const darkModeToggle = document.getElementById('darkModeToggle');
    if (darkModeToggle) {
        darkModeToggle.addEventListener('change', function() {
            toggleDarkMode(this.checked);
            document.getElementById('darkModeSettings').style.display = this.checked ? 'block' : 'none';
        });
    }
    
    // Â§úÈñìÊ®°ÂºèÊ∑±Â∫¶Ë™øÊï¥
    const darkModeDepth = document.getElementById('darkModeDepth');
    if (darkModeDepth) {
        darkModeDepth.addEventListener('input', function() {
            updateDarkModeDepth(this.value);
            document.getElementById('darkModeDepthValue').textContent = this.value + '%';
        });
    }
    
    // ÁÆ°ÁêÜÂàÜÈ°ûÊåâÈàï
    document.getElementById('manageCategoriesBtn').addEventListener('click', function() {
        openCategoryManagement();
    });
    
    document.getElementById('addCategoryBtn').addEventListener('click', addNewCategory);
    
    // ÂàÜÈ°ûÈÅ∏Êìá
    document.getElementById('bookmarkCategory').addEventListener('change', function(e) {
        const newCategoryInput = document.getElementById('newCategoryInput');
        if (!newCategoryInput) return;
        if (e.target.value === 'new') {
            newCategoryInput.classList.remove('hidden');
            newCategoryInput.focus();
        } else {
            newCategoryInput.classList.add('hidden');
        }
    });
    
    // Ë™ûË®ÄÈÅ∏ÊìáÂô®
    const languageSelect = document.getElementById('languageSelect');
    if (languageSelect) {
        languageSelect.addEventListener('change', function() {
            changeLanguage(this.value);
        });
    }
    
    // ÊøæÈè°ÈÅ∏ÊìáÂô®
    const overlaySelect = document.getElementById('overlaySelect');
    if (overlaySelect) {
        overlaySelect.addEventListener('change', function() {
            applyOverlay(this.value);
        });
    }
    
    // ÊøæÈè°ÈÄèÊòéÂ∫¶ÊªëÊ°ø
    const overlayOpacity = document.getElementById('overlayOpacity');
    if (overlayOpacity) {
        overlayOpacity.addEventListener('input', function() {
            updateOverlayOpacity(this.value);
        });
    }
    
    // ÈªûÊìäÂ§ñÈÉ®ÈóúÈñâÂΩàÁ™ó
    window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target.id);
        }
    });
}

// Ë®≠ÁΩÆÊ¥ªÂãïÊ®ôÁ±§
function setActiveEngineTab(engine) {
    document.querySelectorAll('#engineTabs .engine-pill').forEach(pill => {
        const isActive = pill.dataset.engine === engine;
        pill.classList.toggle('active', isActive);
        pill.setAttribute('aria-selected', String(isActive));
    });
}

// Êõ¥Êñ∞ÊêúÂ∞ãÂúñÁ§∫
function updateSearchIcon() {
    const el = document.getElementById('searchEngineIcon');
    if (!el) return;
    const iconData = searchEngines[currentSearchEngine].icon;
    
    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ Lucide ÂúñÊ®ô
    if (iconData.startsWith('lucide:')) {
        const iconName = iconData.replace('lucide:', '');
        el.innerHTML = `<i data-lucide="${iconName}"></i>`;
        if (window.lucide) window.lucide.createIcons();
    } else {
        // ‰ΩøÁî®ÂìÅÁâåÂúñÊ®ô URL
        el.innerHTML = `<img src="${iconData}" alt="${currentSearchEngine}" style="width:20px;height:20px;">`;
    }
}

// Âü∑Ë°åÊêúÂ∞ã
function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) return;
    
    let searchUrl = searchEngines[currentSearchEngine].url;
    
    if (currentSearchEngine === 'custom' && !searchUrl) {
        alert(t('alertSetCustomUrl'));
        openModal('settingsModal');
        return;
    }
    
    searchUrl = searchUrl.replace('{query}', encodeURIComponent(query));
    window.location.href = searchUrl;
}

// ÂàÜÈ°ûÁÆ°ÁêÜ
function loadCategories() {
    const saved = localStorage.getItem('categories');
    categories = saved ? JSON.parse(saved) : [];
    updateCategorySelect();
}

function saveCategories() {
    localStorage.setItem('categories', JSON.stringify(categories));
}

function updateCategorySelect() {
    const select = document.getElementById('bookmarkCategory');
    if (!select) return;
    select.innerHTML = `<option value="">${t('mainList')}</option>`;
    categories.forEach(cat => {
        select.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
    select.innerHTML += `<option value="new">${t('newCategory')}</option>`;
}

// Êõ∏Á±§ÁÆ°ÁêÜ
function loadBookmarks() {
    const saved = localStorage.getItem('bookmarks');
    bookmarks = saved ? JSON.parse(saved) : getDefaultBookmarks();
    renderBookmarks();
}

function getDefaultBookmarks() {
    return [
        { id: Date.now(), name: 'GitHub', url: 'https://github.com', icon: 'https://cdn.simpleicons.org/github', category: '' },
        { id: Date.now() + 1, name: 'YouTube', url: 'https://youtube.com', icon: 'https://cdn.simpleicons.org/youtube', category: '' },
        { id: Date.now() + 2, name: 'Gmail', url: 'https://gmail.com', icon: 'https://cdn.simpleicons.org/gmail', category: '' },
        { id: Date.now() + 3, name: 'X', url: 'https://x.com', icon: 'https://cdn.simpleicons.org/x', category: '' },
        { id: Date.now() + 4, name: 'Notion', url: 'https://notion.so', icon: 'https://cdn.simpleicons.org/notion', category: '' },
        { id: Date.now() + 5, name: 'Instagram', url: 'https://www.instagram.com/', icon: 'https://cdn.simpleicons.org/instagram', category: '' }
    ];
}

function saveBookmarksToStorage() {
    localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
}

function renderBookmarks() {
    const mainGrid = document.getElementById('bookmarkGrid');
    const categoriesContainer = document.getElementById('categorySection');
    if (!mainGrid || !categoriesContainer) return;
    mainGrid.innerHTML = '';
    categoriesContainer.innerHTML = '';
    
    // ÂàÜÈõ¢‰∏ªÊõ∏Á±§ÂíåÂàÜÈ°ûÊõ∏Á±§
    const mainBookmarks = bookmarks.filter(b => !b.category || b.category === '');
    const categorizedBookmarks = {};
    
    bookmarks.forEach(bookmark => {
        if (bookmark.category && bookmark.category !== '') {
            if (!categorizedBookmarks[bookmark.category]) {
                categorizedBookmarks[bookmark.category] = [];
            }
            categorizedBookmarks[bookmark.category].push(bookmark);
        }
    });
    
    // Ê∏≤Êüì‰∏ªÊõ∏Á±§
    mainBookmarks.forEach(bookmark => {
        const bookmarkEl = createBookmarkElement(bookmark);
        mainGrid.appendChild(bookmarkEl);
    });
    
    // Â¶ÇÊûúÊ≤íÊúâ‰∏ªÊõ∏Á±§ÔºåÈ°ØÁ§∫ÊèêÁ§∫
    if (mainBookmarks.length === 0) {
        mainGrid.innerHTML = `<p style="text-align:center; color: var(--text-subtle); padding: 40px;">${t('noBookmarks')}</p>`;
    }
    
    // Ê∏≤ÊüìÂàÜÈ°ûÊõ∏Á±§
    Object.keys(categorizedBookmarks).forEach(category => {
        const section = createCategorySection(category, categorizedBookmarks[category]);
        categoriesContainer.appendChild(section);
    });
}

function createCategorySection(category, categoryBookmarks) {
    const section = document.createElement('div');
    section.className = 'category-section';
    
    const header = document.createElement('div');
    header.className = 'category-header';
    header.innerHTML = `
        <div class="category-title">üìÅ ${category}</div>
        <div class="category-actions">
            <button class="add-btn" onclick="openBookmarkModal(null, '${category.replace(/'/g, "\\'")}')">+ Êñ∞Â¢û</button>
            <button class="manage-btn" onclick="deleteCategory('${category.replace(/'/g, "\\'")}')">Âà™Èô§ÂàÜÈ°û</button>
        </div>
    `;
    
    const grid = document.createElement('div');
    grid.className = 'bookmarks-grid';
    
    categoryBookmarks.forEach(bookmark => {
        const bookmarkEl = createBookmarkElement(bookmark);
        grid.appendChild(bookmarkEl);
    });
    
    section.appendChild(header);
    section.appendChild(grid);
    
    return section;
}

function createBookmarkElement(bookmark) {
    const div = document.createElement('div');
    div.className = 'bookmark-item';
    div.onclick = function(e) {
        if (!e.target.closest('.bookmark-actions')) {
            window.open(bookmark.url, '_blank');
        }
    };
    
    let iconHtml = '';
    // allow explicit null/empty to mean no icon
    if (!bookmark.icon) {
        iconHtml = '';
    } else if (bookmark.icon.startsWith('http')) {
        iconHtml = `<img src="${bookmark.icon}" alt="${bookmark.name}" onerror="this.parentElement.innerHTML='';">`;
    } else if (bookmark.icon.includes('favicon')) {
        iconHtml = `<img src="${bookmark.icon}" alt="${bookmark.name}" onerror="this.parentElement.innerHTML='';">`;
    } else {
        // fallback to text or svg string
        iconHtml = bookmark.icon;
    }
    
    div.innerHTML = `
        <div class="bookmark-actions">
            <button onclick="editBookmark(${bookmark.id}); event.stopPropagation();" title="Á∑®ËºØ"><i data-lucide="pencil" style="width:14px;height:14px;"></i></button>
            <button onclick="deleteBookmark(${bookmark.id}); event.stopPropagation();" title="Âà™Èô§"><i data-lucide="trash-2" style="width:14px;height:14px;"></i></button>
        </div>
        <div class="bookmark-icon">${iconHtml}</div>
        <div class="bookmark-name">${bookmark.name}</div>
    `;
    
    // initialize lucide icons in this element
    if (window.lucide) window.lucide.createIcons({ nameAttr: 'data-lucide' });
    
    return div;
}

function openBookmarkModal(bookmark = null, defaultCategory = '') {
    editingBookmarkId = bookmark ? bookmark.id : null;
    
    const title = document.getElementById('bookmarkTitle');
    const categorySelect = document.getElementById('bookmarkCategory');
    const nameInput = document.getElementById('bookmarkName');
    const urlInput = document.getElementById('bookmarkUrl');
    const iconInput = document.getElementById('bookmarkIcon');
    
    if (title) title.textContent = bookmark ? t('editBookmarkTitle') : t('addBookmarkTitle');
    if (categorySelect) categorySelect.value = bookmark ? bookmark.category : defaultCategory;
    if (nameInput) nameInput.value = bookmark ? bookmark.name : '';
    if (urlInput) urlInput.value = bookmark ? bookmark.url : '';
    if (iconInput) iconInput.value = bookmark ? bookmark.icon : '';
    
    const newCat = document.getElementById('newCategoryInput');
    if (newCat) newCat.classList.add('hidden');
    
    openModal('bookmarkModal');
    if (nameInput) nameInput.focus();
}

function saveBookmark() {
    const categorySelect = document.getElementById('bookmarkCategory');
    const newCategoryInput = document.getElementById('newCategoryInput');
    const name = document.getElementById('bookmarkName').value.trim();
    const url = document.getElementById('bookmarkUrl').value.trim();
    const icon = document.getElementById('bookmarkIcon').value.trim() || '';
    
    if (!name || !url) {
        alert(t('alertFillRequired'));
        return;
    }
    
    let category = categorySelect.value;
    if (category === 'new') {
        category = newCategoryInput.value.trim();
        if (!category) {
            alert(t('alertEnterCategory'));
            return;
        }
        if (!categories.includes(category)) {
            categories.push(category);
            saveCategories();
            updateCategorySelect();
        }
    }
    
    // Á©∫Â≠ó‰∏≤Ë°®Á§∫ÊîæÂú®‰∏ªÂàóË°®
    if (!category) {
        category = '';
    }
    
    // Á¢∫‰øù URL ÊúâÂçîË≠∞
    const finalUrl = url.match(/^https?:\/\//) ? url : 'https://' + url;
    
    if (editingBookmarkId) {
        // Á∑®ËºØÁèæÊúâÊõ∏Á±§
        const index = bookmarks.findIndex(b => b.id === editingBookmarkId);
        if (index !== -1) {
            bookmarks[index] = { ...bookmarks[index], name, url: finalUrl, icon, category };
        }
    } else {
        // Êñ∞Â¢ûÊõ∏Á±§
        bookmarks.push({
            id: Date.now(),
            name,
            url: finalUrl,
            icon,
            category
        });
    }
    
    saveBookmarksToStorage();
    renderBookmarks();
    closeModal('bookmarkModal');
}

function editBookmark(id) {
    const bookmark = bookmarks.find(b => b.id === id);
    if (bookmark) {
        openBookmarkModal(bookmark);
    }
}

function deleteBookmark(id) {
    if (confirm(t('alertDeleteBookmark'))) {
        bookmarks = bookmarks.filter(b => b.id !== id);
        saveBookmarksToStorage();
        renderBookmarks();
    }
}

function deleteCategory(category) {
    const msg = t('alertDeleteCategory').replace('{category}', category);
    if (confirm(msg)) {
        // Â∞áË©≤ÂàÜÈ°ûÁöÑÊõ∏Á±§ÁßªËá≥‰∏ªÂàóË°®
        bookmarks.forEach(bookmark => {
            if (bookmark.category === category) {
                bookmark.category = '';
            }
        });
        
        // ÂæûÂàÜÈ°ûÂàóË°®‰∏≠ÁßªÈô§
        categories = categories.filter(cat => cat !== category);
        
        saveCategories();
        saveBookmarksToStorage();
        updateCategorySelect();
        renderBookmarks();
    }
}

// ÂàÜÈ°ûÁÆ°ÁêÜÂΩàÁ™ó
function openCategoryManagement() {
    const categoryList = document.getElementById('categoryList');
    if (!categoryList) return;
    categoryList.innerHTML = '';
    
    if (categories.length === 0) {
        categoryList.innerHTML = `<p style="text-align:center; color: var(--text-subtle); padding: 20px;">${t('noCategories')}</p>`;
    } else {
        categories.forEach(cat => {
            const item = document.createElement('div');
            item.className = 'category-item';
            item.innerHTML = `
                <span class="category-item-name">üìÅ ${cat}</span>
                <button onclick="deleteCategoryFromModal('${cat}')" class="btn" style="padding: 6px 12px; font-size: 12px;">${t('deleteCategory')}</button>
            `;
            categoryList.appendChild(item);
        });
    }
    
    const newCatInput = document.getElementById('newCategoryName');
    if (newCatInput) newCatInput.value = '';
    openModal('categoryModal');
}

function addNewCategory() {
    const input = document.getElementById('newCategoryName');
    if (!input) return;
    const newCat = input.value.trim();
    
    if (!newCat) {
        alert(t('alertEnterCategory'));
        return;
    }
    
    if (categories.includes(newCat)) {
        alert(t('alertCategoryExists'));
        return;
    }
    
    categories.push(newCat);
    saveCategories();
    updateCategorySelect();
    openCategoryManagement(); // Âà∑Êñ∞ÂàóË°®
}

function deleteCategoryFromModal(category) {
    deleteCategory(category);
    openCategoryManagement(); // Âà∑Êñ∞ÂàóË°®
}

// ÊäìÂèñÁ∂≤Á´ô favicon
async function fetchFavicon() {
    const urlInput = document.getElementById('bookmarkUrl');
    const iconInput = document.getElementById('bookmarkIcon');
    const url = urlInput.value.trim();
    
    if (!url) {
        alert('Ë´ãÂÖàËº∏ÂÖ•Á∂≤ÂùÄ');
        return;
    }
    
    try {
        // Á¢∫‰øù URL ÊúâÂçîË≠∞
        const fullUrl = url.match(/^https?:\/\//) ? url : 'https://' + url;
        const urlObj = new URL(fullUrl);
        
        // ÂòóË©¶Â§öÁ®Æ favicon Áç≤ÂèñÊñπÂºè
        const faviconUrls = [
            `https://www.google.com/s2/favicons?domain=${urlObj.hostname}&sz=128`,
            `${urlObj.origin}/favicon.ico`,
            `https://icon.horse/icon/${urlObj.hostname}`
        ];
        
        // ‰ΩøÁî®Á¨¨‰∏ÄÂÄãÊñπÊ≥ïÔºàGoogle favicon ÊúçÂãôÔºâ
        iconInput.value = faviconUrls[0];
        alert(t('alertIconFetched'));
        
    } catch (error) {
        alert(t('alertInvalidUrl'));
    }
}

// ÂΩàÁ™óÊéßÂà∂
function openModal(modalId) {
    document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// Â§úÈñìÊ®°ÂºèÂäüËÉΩ
function toggleDarkMode(forceState) {
    const isDark = forceState !== undefined ? forceState : !document.body.classList.contains('dark-mode');
    document.body.classList.toggle('dark-mode', isDark);
    localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
    
    // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
    const quickBtn = document.getElementById('quickDarkModeBtn');
    if (quickBtn) {
        quickBtn.classList.toggle('active', isDark);
        const icon = quickBtn.querySelector('i');
        if (icon) {
            icon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            if (window.lucide) window.lucide.createIcons();
        }
    }
    
    // Êõ¥Êñ∞Ë®≠ÁΩÆÈù¢ÊùøÁöÑ checkbox
    const toggle = document.getElementById('darkModeToggle');
    if (toggle) toggle.checked = isDark;
    
    // È°ØÁ§∫/Èö±ËóèÊ∑±Â∫¶Ë®≠ÁΩÆ
    const settings = document.getElementById('darkModeSettings');
    if (settings) settings.style.display = isDark ? 'block' : 'none';
}

function updateDarkModeDepth(depth) {
    const opacity = depth / 100;
    document.documentElement.style.setProperty('--dark-overlay-opacity', opacity);
    localStorage.setItem('darkModeDepth', depth);
}

function loadDarkMode() {
    const darkMode = localStorage.getItem('darkMode');
    const depth = localStorage.getItem('darkModeDepth') || '80';
    
    if (darkMode === 'enabled') {
        toggleDarkMode(true);
    }
    
    const depthInput = document.getElementById('darkModeDepth');
    if (depthInput) {
        depthInput.value = depth;
        document.getElementById('darkModeDepthValue').textContent = depth + '%';
    }
    updateDarkModeDepth(depth);
}

// Ë™ûË®ÄÂæ™Áí∞ÂàáÊèõ
function cycleLanguage() {
    const languages = ['en', 'zh-CN', 'zh-TW'];
    const currentIndex = languages.indexOf(currentLanguage);
    const nextIndex = (currentIndex + 1) % languages.length;
    changeLanguage(languages[nextIndex]);
}

// ÂúñÊ®ôÊêúÁ¥¢ÂäüËÉΩ
function openIconSearch() {
    openModal('iconSearchModal');
    
    // Â∏∏Áî®ÂìÅÁâåÂúñÊ®ô
    const popularIcons = [
        'github', 'google', 'facebook', 'twitter', 'instagram', 'youtube',
        'linkedin', 'reddit', 'discord', 'slack', 'spotify', 'netflix',
        'amazon', 'apple', 'microsoft', 'dropbox', 'notion', 'figma',
        'steam', 'twitch', 'tiktok', 'pinterest', 'telegram', 'whatsapp',
        'gmail', 'outlook', 'yahoo', 'medium', 'stackoverflow', 'wikipedia'
    ];
    
    renderIconGrid(popularIcons);
    
    // ÊêúÁ¥¢Ëº∏ÂÖ•
    const searchInput = document.getElementById('iconSearchInput');
    if (searchInput) {
        searchInput.value = '';
        searchInput.focus();
        searchInput.oninput = function() {
            const query = this.value.toLowerCase().trim();
            if (query) {
                const filtered = popularIcons.filter(icon => icon.includes(query));
                renderIconGrid(filtered.length > 0 ? filtered : [query]);
            } else {
                renderIconGrid(popularIcons);
            }
        };
    }
}

function renderIconGrid(icons) {
    const grid = document.getElementById('iconSearchResults');
    if (!grid) return;
    
    grid.innerHTML = icons.map(icon => `
        <div class="icon-grid-item" onclick="selectIcon('${icon}')">
            <img src="https://cdn.simpleicons.org/${icon}" alt="${icon}" onerror="this.style.display='none'">
            <span>${icon}</span>
        </div>
    `).join('');
}

function selectIcon(iconName) {
    const iconUrl = `https://cdn.simpleicons.org/${iconName}`;
    const iconInput = document.getElementById('bookmarkIcon');
    if (iconInput) {
        iconInput.value = iconUrl;
    }
    closeModal('iconSearchModal');
    alert(`Â∑≤ÈÅ∏ÊìáÂúñÊ®ôÔºö${iconName}`);
}

// Êö¥Èú≤ÂÖ®Â±ÄÂáΩÊï∏
window.openBookmarkModal = openBookmarkModal;
window.editBookmark = editBookmark;
window.deleteBookmark = deleteBookmark;
window.deleteCategory = deleteCategory;
window.deleteCategoryFromModal = deleteCategoryFromModal;
window.selectIcon = selectIcon;
